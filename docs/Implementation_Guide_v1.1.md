# StockAI Trader v1.1 实施指南

目标：在现有 v1.0 单股即时分析能力基础上，新增 **自选股批量分析** 与 **每日自动报告**，覆盖后端、调度、前端展示及运维支持。

---

## 1. 需求拆解

1. **自选股批量分析**
   - 支持用户创建/维护自选股列表（最小可存储在 JSON/SQLite）。
   - 将列表中的多只股票在一次请求中批量分析，并返回结构化结果。
   - 控制并发与节流，避免命中 API 限流。

2. **每日自动报告**
   - 每个交易日生成覆盖自选股的总结报告（文本 + 结构化数据）。
   - 报告内容包括：各股操作建议、当日焦点、风险提示、行情概览。
   - 支持保存历史报告（本地文件/数据库），便于复查。
   - 可通过邮件、Webhook 或前端页面查看最新报告。

---

## 2. 系统模块扩展

### 2.1 数据层（datahub）
- 新增自选股存储接口 `datahub/watchlist.py`：
  - 提供 CRUD 操作，如 `load_watchlist()`, `add_symbol()`, `remove_symbol()`, `save_watchlist()`.
  - 默认使用 `data/watchlist.json`，后续可替换为 SQLite。

- 优化批量抓取：
  - 在 `datahub/fetcher.py` 增加批量接口 `get_candles_batch(tickers, interval)`，内部复用现有多源逻辑。
  - 实现简单的异步限速（如 `asyncio.Semaphore` 控制并发数量，默认 3~5）。
  - 对缓存目录增加命名空间 `batch/`，防止与单股缓存冲突。

### 2.2 分析层（engine）
- 在 `engine/analyzer.py` 新增批量处理函数 `analyze_many(tickers, ...) -> Dict[str, dict]`：
  - 循环调用单股分析逻辑，收集分数、建议与风险。
  - 允许传入用户自定义时间粒度（默认日线）。
  - 返回的数据结构示例：
    ```json
    {
      "AAPL": {"action": "buy", "confidence": 0.74, ...},
      "MSFT": {"action": "hold", ...}
    }
    ```
- 在 `engine/report.py` 添加聚合版渲染函数 `render_daily_report(watchlist_result, market_context)`：
  - 汇总多股结论，列出重点推荐、潜在风险项。
  - 附上宏观/板块概览（可复用现有行情数据或预设段落）。

### 2.3 应用层（API）
- 扩展 FastAPI：
  - `POST /watchlist`：新增或覆盖自选股列表。
  - `GET /watchlist`：返回当前自选股。
  - `POST /watchlist/analyze`：触发批量分析，可接受参数：
    ```json
    {
      "tickers": ["AAPL", "MSFT"],   // 可选；为空时默认读取保存的 watchlist
      "timeframe": "1d"
    }
    ```
  - `GET /reports/latest`：返回最新自动报告（结构化 + 文本）。
  - `GET /reports`：分页返回历史报告元数据。
  - 出错时返回可读信息，例如某只股票数据缺失。

### 2.4 任务调度与存储
- 引入调度器（推荐 APScheduler 或内置 cron）：
  - 在 `scheduler.py`（新文件）中定义每日任务，默认在北京时间 17:30 触发。
  - 任务流程：读取 watchlist → 批量分析 → 生成整合报告 → 保存。
  - 保存策略：
    - 路径：`reports/YYYY-MM-DD.json`（结构化）与 `reports/YYYY-MM-DD.txt`（文本）。
    - 记录执行耗时与数据源状态。

- 提供手动触发脚本 `scripts/run_daily_report.py`，便于开发调试。

### 2.5 前端更新
- 新增自选股管理页面：
  - 列表展示、添加（输入股票代码）、删除操作。
  - 允许直接触发批量分析，结果以表格或卡片展示。

- 每日报告页面：
  - 显示最新报告的摘要、重点推荐、风险提示。
  - 提供历史报告列表/下拉框，可切换查看。
  - 支持导出按钮下载报告文本。

- 交互优化：
  - 批量请求期间显示进度或加载状态。
  - 若某些股票失败，提示用户重试或检查代码。

---

## 3. 实施步骤建议

1. **数据与存储层扩展**
   - 创建 `datahub/watchlist.py` 与必要的目录结构。
   - 编写批量抓取函数与限速逻辑，编写单元测试确认缓存命中。

2. **分析层批量输出**
   - 在 `engine/analyzer.py` 实现 `analyze_many`。
   - 新增测试覆盖多股票场景，验证权重与输出一致性。

3. **API 路由与验证**
   - 扩展 FastAPI 接口，使用 Pydantic 模型校验请求/响应。
   - 为批量分析接口增加超时/熔断机制（例如限制最大股票数量）。

4. **定时任务与报告存储**
   - 引入 APScheduler（或类似库），配置每日调度。
   - 实现报告生成与文件持久化，添加日志记录（成功与错误）。

5. **前端功能迭代**
   - Watchlist 管理界面（Vue 组件 + API 调用）。
   - 日报展示页面与历史报告查询。
   - 提供错误反馈 UI。

6. **联调与 QA**
   - 用真实或模拟数据跑一次完整流程。
   - 检查性能（批量分析 <= 60 秒、报告生成成功率接近 100%）。
   - 验证跨时区定时任务与缓存有效期是否匹配。

7. **部署与运维**
   - 更新 README/部署脚本，说明调度器配置方式。
   - 若部署在容器/云环境，配置环境变量（例如 REPORT_TIME、WATCHLIST_PATH）。
   - 设置基础监控：调度器运行日志、报告文件是否生成等。

---

## 4. 数据结构与接口示例

### 4.1 Watchlist 存储
```json
{
  "updated_at": "2025-02-15T09:00:00+08:00",
  "symbols": ["AAPL", "MSFT", "TSLA", "sh600519"]
}
```

### 4.2 批量分析响应
```json
{
  "as_of": "2025-02-15T09:15:00Z",
  "timeframe": "1d",
  "results": {
    "AAPL": {
      "action": "buy",
      "confidence": 0.76,
      "entry": 187.2,
      "stop": 180.5,
      "targets": [192.0, 196.5],
      "rationale": [...],
      "risk_notes": [...]
    },
    "MSFT": { "...": "..." }
  },
  "failed": ["TSLA"],               # 可选失败列表
  "latency_ms": 3240
}
```

### 4.3 每日报告示例
```json
{
  "date": "2025-02-15",
  "generated_at": "2025-02-15T17:32:10+08:00",
  "market_overview": "美股科技股延续强势，A 股窄幅震荡...",
  "highlights": [
    {"ticker": "AAPL", "summary": "趋势与动量同步增强，建议回踩买入。"},
    {"ticker": "sh600519", "summary": "资金面走弱，保持观望。"}
  ],
  "risks": [
    "美元指数上行压制成长股估值",
    "人民币汇率波动加大"
  ],
  "details": {
    "AAPL": { "...": "..." },
    "sh600519": { "...": "..." }
  }
}
```

---

## 5. 测试与验收

- **单元测试**
  - Watchlist CRUD 操作。
  - 批量分析逻辑：数据源降级、缓存命中、错误处理。
  - 报告生成：确保输出字段完整。

- **集成测试**
  - 运行一次完整定时任务，确认报告文件生成。
  - 模拟部分股票失败的场景，确认批量接口返回 `failed` 字段。

- **性能测试**
  - 在 watchlist 规模为 20~30 只股票时，分析耗时应小于 60 秒。
  - 检查调度器的资源占用与日志输出。

- **用户体验**
  - 前端页面响应时间 < 3 秒。
  - 批量分析失败时给出明确提示。
  - 每日报告页面支持刷新和历史查询。

---

## 6. 交付物清单

1. Watchlist 数据模块与批量抓取优化。
2. 批量分析 API 与前端页面。
3. 日志化的定时任务及报告持久化机制。
4. 每日报告展示页面与历史记录浏览。
5. 更新后的 README/部署文档。
6. 对应单元测试与集成测试用例。

---

## 7. 后续可扩展方向

- 邮件或 Slack/Webhook 推送每日报告。
- 支持多市场多 watchlist（如区分美股/A 股自选）。
- 引入 Redis/Celery 进行分布式任务调度。
- 对接自动化回测或策略回放功能。

以上即 v1.1 的实施指南，可作为后续开发的路线图与执行清单。

